<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Arabic MIDI Keyboard by Zaher Alkaei</title>
    <style>
        body {
            background-color: black;
            color: white;
            font-family: Arial, sans-serif;
            text-align: center;
        }
        /* Styling for the keys */
        .key {
            display: inline-block;
            width: 40px;
            height: 200px;
            border: 1px solid black;
            margin: 2px;
            cursor: pointer;
        }
        .white-key {
            background-color: white;
            position: relative;
        }
        .black-key {
            background-color: black;
            height: 120px;
            width: 30px;
            position: absolute;
            z-index: 1;
            margin-left: -15px;
        }
        .key-container {
            position: relative;
            display: inline-block;
        }
        .pressed {
            background-color: yellow !important;
        }
        /* Styling for control buttons and dropdown */
        .controls {
            margin: 10px 0;
            display: inline-block;
        }
        .controls button, .controls select {
            margin: 5px;
            padding: 10px;
            border: 1px solid white;
            background-color: black;
            color: white;
            cursor: pointer;
            font-size: 16px;
        }
        .controls button.active {
            background-color: lightgreen;
            color: black;
        }
        .note {
            margin-top: 10px;
        }
        #keyboard-container {
            border: 1px solid white;
            padding: 20px;
            display: inline-block;
        }
    </style>
</head>
<body>
    <h1>The Arabic MIDI Keyboard</h1>
    <p>by Zaher Alkaei</p>
    <div id="keyboard-container">
        <div id="keyboard">
            <!-- Keys will be generated by JavaScript -->
        </div>
    </div>
    <div class="controls">
        <button data-note="C">Lower C</button>
        <button data-note="C#">Lower C#</button>
        <button data-note="D">Lower D</button>
        <button data-note="D#">Lower D#</button>
        <button data-note="E">Lower E</button>
        <button data-note="F">Lower F</button>
        <button data-note="F#">Lower F#</button>
        <button data-note="G">Lower G</button>
        <button data-note="G#">Lower G#</button>
        <button data-note="A">Lower A</button>
        <button data-note="A#">Lower A#</button>
        <button data-note="B">Lower B</button>
        <p>Note: The row of buttons above lowers the pitch by a quarter tone.</p>
        <select id="instrument-voice">
            <option value="sine">Piano</option>
            <option value="triangle">Strings</option>
            <option value="square">Harp</option>
            <option value="sawtooth">Synth</option>
            <option value="custom1">Flute</option>
            <option value="custom2">Organ</option>
        </select>
        <button id="toggle-reverb">Toggle Reverb</button>
        <button id="toggle-arpeggiator">Toggle Arpeggiator</button>
    </div>
    <script>
        const noteFrequencies = {
            'C4': 261.63,
            'C#4': 277.18,
            'D4': 293.66,
            'D#4': 311.13,
            'E4': 329.63,
            'F4': 349.23,
            'F#4': 369.99,
            'G4': 392.00,
            'G#4': 415.30,
            'A4': 440.00,
            'A#4': 466.16,
            'B4': 493.88,
            'C5': 523.25,
            'C#5': 554.37,
            'D5': 587.33,
            'D#5': 622.25,
            'E5': 659.25,
            'F5': 698.46,
            'F#5': 739.99,
            'G5': 783.99,
            'G#5': 830.61,
            'A5': 880.00,
            'A#5': 932.33,
            'B5': 987.77,
            'C6': 1046.50,
            'C#6': 1108.73,
            'D6': 1174.66,
            'D#6': 1244.51,
            'E6': 1318.51,
            'F6': 1396.91,
            'F#6': 1479.98,
            'G6': 1567.98,
            'G#6': 1661.22,
            'A6': 1760.00,
            'A#6': 1864.66,
            'B6': 1975.53,
            'C7': 2093.00
        };

        const keyMap = {
            'q': 'C4', '2': 'C#4', 'w': 'D4', '3': 'D#4', 'e': 'E4', 'r': 'F4', '5': 'F#4', 't': 'G4', '6': 'G#4', 'y': 'A4', '7': 'A#4', 'u': 'B4', 'i': 'C5', '9': 'C#5', 'o': 'D5', '0': 'D#5', 'p': 'E5', '[': 'F5', '=': 'F#5', ']': 'G5', '\\': 'G#5',
            'z': 'C5', 's': 'C#5', 'x': 'D5', 'd': 'D#5', 'c': 'E5', 'v': 'F5', 'g': 'F#5', 'b': 'G5', 'h': 'G#5', 'n': 'A5', 'j': 'A#5', 'm': 'B5', ',': 'C6', 'l': 'C#6', '.': 'D6', ';': 'D#6', '/': 'E6'
        };

        const context = new (window.AudioContext || window.webkitAudioContext)();
        const keys = {};
        const pitchAdjustments = {
            'C': 0,
            'C#': 0,
            'D': 0,
            'D#': 0,
            'E': 0,
            'F': 0,
            'F#': 0,
            'G': 0,
            'G#': 0,
            'A': 0,
            'A#': 0,
            'B': 0
        };
        let currentVoice = 'sine';
        const activeOscillators = {};
        let reverbNode = null;
        let isReverbOn = false;
        let isArpeggiatorOn = false;
        let arpeggiatorInterval = null;
        let arpeggiatorNotes = [];
        let arpeggiatorIndex = 0;

        // Function to create a reverb effect
        function createReverb() {
            const convolver = context.createConvolver();
            const noiseBuffer = context.createBuffer(2, context.sampleRate * 3, context.sampleRate);
            const left = noiseBuffer.getChannelData(0);
            const right = noiseBuffer.getChannelData(1);
            for (let i = 0; i < noiseBuffer.length; i++) {
                left[i] = Math.random() * 2 - 1;
                right[i] = Math.random() * 2 - 1;
            }
            convolver.buffer = noiseBuffer;
            return convolver;
        }

        // Function to play a frequency with the current voice and add an envelope
        function playFrequency(note, frequency) {
            const oscillator = context.createOscillator();
            const gainNode = context.createGain();
            oscillator.frequency.setValueAtTime(frequency, context.currentTime);

            switch (currentVoice) {
                case 'custom1':  // Flute
                    oscillator.type = 'sine';
                    break;
                case 'custom2':  // Organ
                    oscillator.type = 'square';
                    break;
                default:
                    oscillator.type = currentVoice;
            }

            oscillator.connect(gainNode);
            if (isReverbOn) {
                if (!reverbNode) {
                    reverbNode = createReverb();
                }
                gainNode.connect(reverbNode);
                reverbNode.connect(context.destination);
            } else {
                gainNode.connect(context.destination);
            }

            const attackTime = 0.1;
            const releaseTime = 0.1;
            gainNode.gain.setValueAtTime(0, context.currentTime);
            gainNode.gain.linearRampToValueAtTime(1, context.currentTime + attackTime);
            gainNode.gain.linearRampToValueAtTime(0, context.currentTime + attackTime + releaseTime);

            oscillator.start();
            oscillator.stop(context.currentTime + attackTime + releaseTime);

            if (!activeOscillators[note]) {
                activeOscillators[note] = [];
            }
            activeOscillators[note].push(oscillator);
        }

        // Function to stop playing a note
        function stopFrequency(note) {
            if (activeOscillators[note]) {
                activeOscillators[note].forEach(oscillator => oscillator.stop());
                activeOscillators[note] = [];
            }
        }

        // Function to adjust the frequency based on pitch adjustments
        function adjustFrequency(note, frequency) {
            const baseNote = note.slice(0, -1);  // Extract the base note without the octave number
            const adjustment = pitchAdjustments[baseNote];
            return frequency * Math.pow(2, adjustment / 1200);
        }

        // Function to create a key element
        function createKey(note, frequency, isBlack) {
            const key = document.createElement('div');
            key.className = `key ${isBlack ? 'black-key' : 'white-key'}`;
            key.addEventListener('mousedown', () => handleKeyDown({ key: note }));
            key.addEventListener('mouseup', () => handleKeyUp({ key: note }));
            key.addEventListener('touchstart', (e) => {
                e.preventDefault();
                handleKeyDown({ key: note });
            });
            key.addEventListener('touchend', (e) => {
                e.preventDefault();
                handleKeyUp({ key: note });
            });
            key.addEventListener('touchcancel', (e) => {
                e.preventDefault();
                handleKeyUp({ key: note });
            });
            keys[note] = key;
            return key;
        }

        // Function to generate the keyboard
        function generateKeyboard() {
            const keyboard = document.getElementById('keyboard');
            const notes = Object.keys(noteFrequencies);

            notes.forEach(note => {
                const isBlack = note.includes('#');
                const keyContainer = document.createElement('div');
                keyContainer.className = 'key-container';
                
                const key = createKey(note, noteFrequencies[note], isBlack);
                keyContainer.appendChild(key);

                if (!isBlack) {
                    keyboard.appendChild(keyContainer);
                } else {
                    const previousKeyContainer = keyboard.lastElementChild;
                    if (previousKeyContainer) {
                        previousKeyContainer.appendChild(key);
                    }
                }
            });
        }

        // Event handler for keydown events
        function handleKeyDown(event) {
            const note = keyMap[event.key] || event.key;
            if (note && keys[note]) {
                const adjustedFrequency = adjustFrequency(note, noteFrequencies[note]);
                if (isArpeggiatorOn) {
                    if (!arpeggiatorNotes.some(n => n.note === note)) {
                        arpeggiatorNotes.push({ note, adjustedFrequency });
                    }
                } else {
                    playFrequency(note, adjustedFrequency);
                    keys[note].classList.add('pressed');
                }
            }
        }

        // Event handler for keyup events
        function handleKeyUp(event) {
            const note = keyMap[event.key] || event.key;
            if (note && keys[note]) {
                stopFrequency(note);
                keys[note].classList.remove('pressed');
            }
        }

        // Event handler for pitch adjustment button clicks
        function handleButtonClick(event) {
            const note = event.target.getAttribute('data-note');
            if (note) {
                if (pitchAdjustments[note] === 0) {
                    pitchAdjustments[note] = -50;
                    event.target.classList.add('active');
                } else {
                    pitchAdjustments[note] = 0;
                    event.target.classList.remove('active');
                }
            }
        }

        // Event handler for changing the instrument voice
        function handleVoiceChange(event) {
            currentVoice = event.target.value;
        }

        // Toggle reverb effect
        function toggleReverb() {
            isReverbOn = !isReverbOn;
            document.getElementById('toggle-reverb').classList.toggle('active', isReverbOn);
        }

        // Toggle arpeggiator
        function toggleArpeggiator() {
            isArpeggiatorOn = !isArpeggiatorOn;
            if (isArpeggiatorOn) {
                arpeggiatorInterval = setInterval(() => {
                    if (arpeggiatorNotes.length > 0) {
                        const noteInfo = arpeggiatorNotes[arpeggiatorIndex];
                        playFrequency(noteInfo.note, noteInfo.adjustedFrequency);
                        arpeggiatorIndex = (arpeggiatorIndex + 1) % arpeggiatorNotes.length;
                    }
                }, 200); // Adjust the interval for the arpeggiator speed
            } else {
                clearInterval(arpeggiatorInterval);
                arpeggiatorNotes = [];
                arpeggiatorIndex = 0;
            }
            document.getElementById('toggle-arpeggiator').classList.toggle('active', isArpeggiatorOn);
        }

        document.addEventListener('keydown', handleKeyDown);
        document.addEventListener('keyup', handleKeyUp);
        document.querySelectorAll('.controls button[data-note]').forEach(button => {
            button.addEventListener('click', handleButtonClick);
        });
        document.getElementById('instrument-voice').addEventListener('change', handleVoiceChange);
        document.getElementById('toggle-reverb').addEventListener('click', toggleReverb);
        document.getElementById('toggle-arpeggiator').addEventListener('click', toggleArpeggiator);

        generateKeyboard();
    </script>
</body>
</html>
